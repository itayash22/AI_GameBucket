<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Gaming</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS Reset & Basic Setup --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --pixel-font: 'Press Start 2P', cursive;
            --bg-color: #000020; /* Deep blue */
            --primary-color: #FFFFFF; /* White */
            --secondary-color: #00FF00; /* Bright Green */
            --accent-color: #FF00FF; /* Magenta */
            --border-color: var(--secondary-color);
            --error-color: #FF3333; /* Red */
            --button-bg: var(--accent-color);
            --button-text: var(--primary-color);
            --card-bg: #111133;
            --input-bg: #222244;
            --link-color: var(--secondary-color);
            --placeholder-bg: #333355; /* Darker placeholder */
        }

        html {
            font-size: 10px; 
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--pixel-font);
            background-color: var(--bg-color);
            color: var(--primary-color);
            line-height: 1.6;
            font-size: 1.4rem; 
            padding-bottom: 60px; 
            position: relative;
            min-height: 100vh;
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            background-color: var(--placeholder-bg); 
        }

        a {
            color: var(--link-color);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        input, textarea, select, button {
            font-family: inherit;
            font-size: inherit;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--primary-color);
            border-radius: 0; 
        }
        input:focus, textarea:focus, select:focus {
             outline: 2px solid var(--accent-color);
        }

        button {
            cursor: pointer;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--border-color);
            box-shadow: 3px 3px 0px var(--border-color);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            border-radius: 0; 
        }
        button:hover {
             transform: translate(1px, 1px);
             box-shadow: 2px 2px 0px var(--border-color);
        }
        button:active {
             transform: translate(3px, 3px);
             box-shadow: 0px 0px 0px var(--border-color);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            background-color: #555;
            border-color: #777;
        }

        /* --- Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            padding: 15px 0; /* Reduced padding */
            border-bottom: 4px solid var(--border-color);
            margin-bottom: 20px; 
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px; 
            flex-direction: column; /* Stack header items vertically */
        }
        
        .header-content {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            width: 100%; 
            margin-bottom: 10px; 
            flex-wrap: wrap; 
        }

        .header-content h1 {
             margin-bottom: 0px; 
             text-align: center;
             font-size: 2.8rem; /* Ensure h1 style is defined */
             color: var(--secondary-color);
             text-shadow: 2px 2px var(--accent-color);
             margin-right: 0; /* Ensure no extra margin */
        }
        
        .tagline {
            font-size: 1.2rem; 
            color: var(--accent-color); 
            text-align: center;
            margin-top: 0px; 
            line-height: 1.3;
        }

        .header-icon {
            width: 32px; 
            height: 32px; 
            image-rendering: pixelated; 
            vertical-align: middle; 
        }

        nav#nav-links {
            margin-bottom: 15px; 
            width: auto; 
            text-align: center; /* Center nav links */
        }

        nav#nav-links a, nav#nav-links button {
            margin: 0 8px; /* Adjusted spacing */
            font-size: 1.4rem;
            background: none;
            border: none;
            box-shadow: none;
            color: var(--link-color);
            padding: 5px;
        }
         nav#nav-links a:hover, nav#nav-links button:hover {
             text-decoration: underline;
             transform: none;
         }

        #icon-strip {
            display: flex;
            flex-direction: row; 
            flex-wrap: wrap; 
            justify-content: center; /* Center icons */
            align-items: center;
            padding: 10px 0; /* Adjusted padding */
            margin-bottom: 15px; /* Adjusted margin */
            border-top: 3px solid var(--border-color);
            border-bottom: 3px solid var(--border-color);
            background-color: rgba(0,0,0, 0.2); 
            gap: 15px; 
            width: 100%; 
        }

        .strip-icon {
            height: 100px; /* Larger icon height */
            width: auto; 
            image-rendering: pixelated; 
            max-width: 100%; 
            display: inline-block; 
            vertical-align: middle; 
        }
        
        .main-content {
            display: flex;
            gap: 20px;
        }

        main {
            flex: 3; 
            min-width: 0; 
        }

        aside#sidebar {
            flex: 1;
            border-left: 4px solid var(--border-color);
            padding-left: 20px;
        }
         aside#sidebar h3 {
             margin-bottom: 10px;
             color: var(--secondary-color);
         }
         aside#sidebar ul {
             list-style: none;
             padding: 0;
             margin: 0;
         }
         aside#sidebar li a {
            display: block;
            padding: 5px 0;
            font-size: 1.3rem;
         }

        footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            border-top: 4px solid var(--border-color);
            background-color: var(--bg-color);
            font-size: 1.2rem;
            height: 60px; 
        }

        /* --- Views --- */
        .view { display: none; } 
        .view.active { display: block; } 

        /* --- Game List View --- */
        #view-game-list .filters {
            margin-bottom: 20px;
            display: flex;
            gap: 15px; 
            align-items: center;
            flex-wrap: wrap;
        }
         #view-game-list .filters label {
             margin-right: 5px;
         }

        #game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 25px; 
             /* text-align removed - handled by .no-games-message */
        }
        
        .no-games-message {
            grid-column: 1 / -1; /* Span full grid width */
            text-align: center;  /* Center the text */
            padding: 40px 15px;  /* Add some vertical padding */
            color: var(--secondary-color); /* Use secondary color */
            font-size: 1.6rem;
        }

        .game-card {
            border: 3px solid var(--border-color);
            padding: 15px;
            background-color: var(--card-bg);
            box-shadow: 4px 4px 0px var(--secondary-color);
            display: flex;
            flex-direction: column;
        }
        .game-card img.preview {
            width: 100%;
            aspect-ratio: 4 / 3;
            object-fit: cover; 
            background-color: var(--placeholder-bg);
            margin-bottom: 10px;
            border: 2px solid var(--border-color);
            display: block;
        }
        .game-card h3 {
            font-size: 1.5rem; 
            margin-bottom: 5px;
            color: var(--secondary-color);
            overflow-wrap: break-word; 
            word-break: break-all; 
             min-height: 3em; 
        }
        .game-card .category {
            font-size: 1.1rem;
            color: var(--accent-color);
            margin-bottom: 8px; 
            display: block;
        }
        .game-card .likes {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
         .game-card .description-preview {
             font-size: 1.2rem;
             margin-bottom: 10px;
             flex-grow: 1; 
             color: #ccc;
             display: -webkit-box;
             -webkit-line-clamp: 3;
             -webkit-box-orient: vertical;
             overflow: hidden;
             text-overflow: ellipsis;
             min-height: 4.8em; 
         }

        .game-card button {
             align-self: flex-start; 
        }

        /* --- Game Play View --- */
         #view-game-play button#back-button { margin-bottom: 15px; }
        #view-game-play #game-title {
            font-size: 2.4rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
            word-break: break-all;
        }
        #game-iframe-container {
            position: relative;
            width: 100%;
            height: 60vh; 
            margin-bottom: 15px;
            background-color: #000;
            border: 4px solid var(--border-color);
        }
        #game-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background-color: #000; 
        }
         #game-details { margin-bottom: 15px; }
         #game-details p {
             margin-bottom: 10px;
             word-break: break-word;
         }
         #game-details p span {
             color: var(--secondary-color); 
         }
        #game-actions button {
            margin-right: 10px;
            margin-bottom: 10px; 
        }
         #like-button.liked {
             background-color: var(--secondary-color);
             color: var(--bg-color);
             box-shadow: 3px 3px 0px var(--accent-color);
         }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%;
        }
        .form-group textarea {
             min-height: 100px;
             resize: vertical;
        }
         .form-group input[type="file"] {
             background-color: transparent;
             border: none;
             padding: 5px 0; 
         }
         .form-group input[type="file"]::file-selector-button {
              font-family: inherit;
              font-size: inherit;
              padding: 8px 12px;
              border: 2px solid var(--border-color);
              background-color: var(--button-bg);
              color: var(--button-text);
              cursor: pointer;
              box-shadow: 3px 3px 0px var(--border-color);
              margin-right: 10px; 
              border-radius: 0;
         }
         .form-group input[type="file"]::file-selector-button:hover {
             transform: translate(1px, 1px);
             box-shadow: 2px 2px 0px var(--border-color);
         }


        /* --- Modals --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 20, 0.8); 
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 10% auto;
            padding: 25px;
            border: 4px solid var(--border-color);
            width: 85%; 
            max-width: 500px;
            position: relative;
            box-shadow: 6px 6px 0px var(--accent-color);
        }
        .modal-close {
            position: absolute;
            top: 5px;
            right: 15px;
            color: var(--primary-color);
            font-size: 3rem;
            font-weight: bold;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0; 
        }
        .modal-close:hover, .modal-close:focus {
             color: var(--accent-color);
             transform: none; 
             box-shadow: none;
        }
         .modal h2 {
             margin-bottom: 15px;
             color: var(--secondary-color);
             font-size: 2rem; 
         }
         #modal-message .modal-body {
             font-size: 1.6rem;
             text-align: center;
             min-height: 50px;
             display: flex;
             align-items: center;
             justify-content: center;
             word-break: break-word;
         }

        /* --- Terms View --- */
         #view-terms {
             border: 3px solid var(--border-color);
             padding: 20px;
             background-color: var(--card-bg);
             max-height: 70vh;
             overflow-y: auto;
         }
          #view-terms button#terms-back-button { margin-bottom: 15px; }
         #view-terms h2 {
             color: var(--secondary-color);
             margin-bottom: 15px;
         }
          #view-terms h3 {
             color: var(--accent-color);
             margin-bottom: 10px;
             margin-top: 15px;
         }
          #view-terms ul { margin-left: 20px; margin-bottom: 10px; }


        /* --- Ad Slots --- */
        .ad-slot {
            border: 2px dashed var(--accent-color);
            padding: 10px;
            margin: 20px 0; 
            min-height: 100px; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: var(--input-bg);
            width: 100%; 
        }
         #ad-slot-header { min-height: 90px; }
         #ad-slot-sidebar { min-height: 250px; margin-top: 0; } 

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .error-message { color: var(--error-color); font-size: 1.2rem; margin-top: 5px; display: block; }
        .loading-indicator { text-align: center; font-size: 1.8rem; padding: 30px; color: var(--secondary-color); }
        .sr-only { 
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }


        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            aside#sidebar {
                border-left: none;
                border-top: 4px solid var(--border-color);
                padding-left: 0;
                padding-top: 20px;
            }
             header { flex-direction: column; align-items: stretch; }
            /* header h1 { text-align: center; margin-right: 0; margin-bottom: 10px; } */ /* Let header-content handle centering */
            nav#nav-links { text-align: center; margin-bottom: 10px; } 
            nav#nav-links a, nav#nav-links button { margin: 0 8px; }
             #ad-slot-header { order: 3; } 

            .modal-content { width: 90%; margin: 15% auto;}
            #game-iframe-container { height: 50vh; } 
        }
         @media (max-width: 480px) {
             html { font-size: 9px; } 
             #game-grid {
                 grid-template-columns: 1fr; 
                 gap: 15px;
             }
             /* header h1 { font-size: 2rem; } */ /* Handled by .header-content */
             .header-icon { /* Smaller header icons */
                 width: 24px;
                 height: 24px;
             }
             .tagline { font-size: 1.0rem; }
             
             .strip-icon { /* Smaller strip icons */
                 height: 70px; 
             }
             #icon-strip { /* Adjustments for smaller strip icons */
                 gap: 10px;
                 padding: 8px 0;
                 margin-bottom: 20px;
             }

             nav#nav-links a, nav#nav-links button { font-size: 1.4rem; } 
             button { padding: 8px 10px; } 
             #view-game-play #game-title { font-size: 2rem; }
         }

    </style>
</head>

<body> {/* REMOVED DUPLICATE BODY TAG */}
    <div class="container">
        <header>
            <div class="header-content">
                <img src="images/8-Bit Space Alien.png" alt="Space Alien Icon" class="header-icon">

                <div>
                    <h1><a href="#/" style="color: inherit; text-decoration: none;">Vibe Gaming</a></h1>
                    <p class="tagline">One File Games Created by AI Vibe Coding</p>
                </div>

                <img src="images/8-Bit Coder.png" alt="Coder Icon" class="header-icon">
            </div>

            <nav id="nav-links">
                <a href="#/" data-view="game-list">Home</a>
                <a href="#/upload" data-view="upload-form" class="requires-login hidden">Upload</a>
                <a href="#/login" id="login-link" data-modal="login">Login</a>
                <a href="#/register" id="register-link" data-modal="register">Register</a>
                <button id="logout-button" class="requires-login hidden">Logout</button>
            </nav>

            <div id="ad-slot-header" class="ad-slot">
                 <p>ADVERTISEMENT - HEADER<br>(728x90 recommended)<br>(Replace this with your ad code/image)</p>
            </div>
            </header>

        <div id="icon-strip">
            <img src="images/8-Bit Sword Warrior.png" alt="Sword Warrior Icon" class="strip-icon">
            <img src="images/8-Bit Space Alien.png" alt="Space Alien Icon" class="strip-icon">
            <img src="images/Pixel Ghost.png" alt="Pixel Ghost Icon" class="strip-icon">
            <img src="images/8-Bit Coin.png" alt="Coin Icon" class="strip-icon">
            <img src="images/Pixel Potion.png" alt="Pixel Potion Icon" class="strip-icon">
            <img src="images/8-Bit Coder.png" alt="Coder Icon" class="strip-icon">
            <img src="images/8-Bit Broccoli.png" alt="Broccoli Icon" class="strip-icon">
        </div>
        <div class="main-content">
            <main>
                <div id="view-game-list" class="view active">
                    <h2>Browse Games</h2>
                    <div class="filters">
                         <label for="category-filter">Category:</label>
                         <select id="category-filter">
                             <option value="">All</option>
                             <option value="Action">Action</option>
                             <option value="Puzzle">Puzzle</option>
                             <option value="Adventure">Adventure</option>
                             <option value="Arcade">Arcade</option>
                             <option value="Simulation">Simulation</option>
                             <option value="Other">Other</option>
                         </select>
                         <label for="sort-by">Sort By:</label>
                         <select id="sort-by">
                             <option value="created_at.desc">Newest</option>
                             <option value="likes_count.desc">Most Liked</option>
                             <option value="title.asc">Title (A-Z)</option>
                         </select>
                    </div>
                    <div id="game-grid" class="loading-indicator">Loading games...</div>
                </div>

                <div id="view-game-play" class="view">
                    <button id="back-button">&lt; Back to List</button>
                    <h2 id="game-title">Loading Game...</h2>
                    <div id="game-iframe-container">
                        <iframe id="game-iframe" sandbox="allow-scripts allow-same-origin" title="Game Area" src="about:blank"></iframe>
                    </div>
                    <div id="game-details">
                        <p>Uploader: <span id="game-uploader">...</span></p>
                        <p>Category: <span id="game-category">...</span></p>
                        <p>Description:</p>
                        <p id="game-description">...</p>
                    </div>
                    <div id="game-actions">
                        <button id="like-button" class="requires-login hidden" disabled><span class="sr-only">Like status: </span>Like</button>
                        <span>Likes: <span id="like-count">0</span></span>
                        <button id="download-button" class="requires-login hidden" disabled>Download</button>
                        <button id="report-button" class="requires-login hidden" disabled>Report</button>
                    </div>
                </div>

                <div id="view-upload-form" class="view requires-login hidden">
                    <h2>Upload Your Game</h2>
                    <form id="upload-form">
                         <div class="form-group">
                            <label for="upload-title">Game Title:</label>
                            <input type="text" id="upload-title" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="upload-description">Description:</label>
                            <textarea id="upload-description" required maxlength="500"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="upload-category">Category:</label>
                            <select id="upload-category" required>
                                <option value="" disabled selected>Select a category...</option>
                                <option value="Action">Action</option>
                                <option value="Puzzle">Puzzle</option>
                                <option value="Adventure">Adventure</option>
                                <option value="Arcade">Arcade</option>
                                <option value="Simulation">Simulation</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="upload-game-file">Game File (.html only):</label>
                            <input type="file" id="upload-game-file" accept=".html" required>
                        </div>
                        <div class="form-group">
                            <label for="upload-preview-image">Preview Image (Optional, JPG/PNG/GIF):</label>
                            <input type="file" id="upload-preview-image" accept="image/*">
                        </div>
                        <button type="submit" id="upload-submit-button">Upload Game</button>
                        <p id="upload-status" class="loading-indicator hidden"></p>
                        <p id="upload-error" class="error-message hidden"></p>
                    </form>
                </div>

                 <div id="view-terms" class="view">
                     <button id="terms-back-button">&lt; Back</button>
                     <h2>Terms of Service & Content Policy</h2>
                     <p><strong>Welcome to Vibe Gaming!</strong></p>
                     <p>This site allows users to share and play single-file games, often created with the help of AI. By using this site (Browse, uploading, downloading, liking, or registering), you agree to these terms.</p>
                     <h3>1. User Accounts:</h3>
                     <ul><li>You need to register an account to upload, download, or like games.</li><li>You are responsible for keeping your account information secure.</li><li>Browse games does not require registration.</li></ul>
                     <h3>2. Content Uploads:</h3>
                     <ul><li>You may only upload single-file games (primarily `.html` format) that you have the right to share.</li><li>You grant Vibe Gaming a license to host, display, and allow users to play and download your uploaded games.</li><li>You are responsible for the content you upload.</li></ul>
                     <h3>3. Prohibited Content:</h3>
                     <ul><li>Do not upload content that is illegal, hateful, harassing, threatening, pornographic, excessively violent, or infringes on copyright or intellectual property.</li><li>Do not upload malicious code (viruses, spyware, etc.). All games run in a sandboxed environment for security, but malicious intent is forbidden.</li></ul>
                     <h3>4. Playing Games:</h3>
                     <ul><li>Games are provided by other users "as is". Vibe Gaming does not guarantee the quality, functionality, or safety of user-uploaded games, although we use sandboxing for security. Play at your own discretion.</li></ul>
                     <h3>5. Reporting Content:</h3>
                     <ul><li>You can report games you believe violate these terms using the "Report" feature. Please provide a clear reason.</li><li>Vibe Gaming reserves the right to review reported content and remove any content at its sole discretion, without notice.</li></ul>
                     <h3>6. Advertising:</h3>
                     <ul><li>This site may display advertising to support its operation.</li></ul>
                     <h3>7. Disclaimers:</h3>
                     <ul><li>Vibe Gaming is provided "as is". We make no warranties regarding site uptime or data retention.</li><li>We reserve the right to modify or discontinue the service at any time.</li></ul>
                     <h3>8. Governing Law:</h3>
                     <ul><li>These terms shall be governed by the laws of Israel.</li></ul>
                     <p><strong>By using this site, you acknowledge and agree to these terms.</strong></p>
                     </div>
            </main>

            <aside id="sidebar">
                <h3>Categories</h3>
                <ul id="sidebar-categories">
                   <li><a href="#/category/All" data-category="">All</a></li>
                   <li><a href="#/category/Action" data-category="Action">Action</a></li>
                   <li><a href="#/category/Puzzle" data-category="Puzzle">Puzzle</a></li>
                   <li><a href="#/category/Adventure" data-category="Adventure">Adventure</a></li>
                   <li><a href="#/category/Arcade" data-category="Arcade">Arcade</a></li>
                   <li><a href="#/category/Simulation" data-category="Simulation">Simulation</a></li>
                   <li><a href="#/category/Other" data-category="Other">Other</a></li>
                </ul>
                <hr style="border: none; border-top: 2px solid var(--border-color); margin: 20px 0;">
                 <div id="ad-slot-sidebar" class="ad-slot">
                     <p>ADVERTISEMENT - SIDEBAR<br>(e.g., 300x250)<br>(Replace this with your ad code/image)</p>
                 </div>
                 </aside>
        </div> <footer>
            <p>&copy; <span id="copyright-year"></span> Vibe Gaming. All rights reserved.</p>
            <a href="#/terms" id="terms-link">Terms of Service</a>
        </footer>
    </div> <div id="modal-login" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-modal="login">&times;</button>
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" required autocomplete="current-password">
                </div>
                <button type="submit">Login</button>
                <p id="login-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <div id="modal-register" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-modal="register">&times;</button>
            <h2>Register</h2>
            <form id="register-form">
                 <div class="form-group">
                    <label for="register-email">Email:</label>
                    <input type="email" id="register-email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password (min 6 chars):</label>
                    <input type="password" id="register-password" required minlength="6" autocomplete="new-password">
                </div>
                 <div class="form-group">
                     <label for="register-password-confirm">Confirm Password:</label>
                     <input type="password" id="register-password-confirm" required minlength="6" autocomplete="new-password">
                 </div>
                <button type="submit">Register</button>
                <p id="register-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <div id="modal-report" class="modal">
         <div class="modal-content">
            <button class="modal-close" data-modal="report">&times;</button>
            <h2>Report Game</h2>
            <form id="report-form">
                <input type="hidden" id="report-game-id">
                <div class="form-group">
                    <label for="report-reason">Reason for reporting:</label>
                    <textarea id="report-reason" required maxlength="500"></textarea>
                </div>
                <button type="submit">Submit Report</button>
                <p id="report-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>

     <div id="modal-message" class="modal">
         <div class="modal-content">
            <button class="modal-close" data-modal="message">&times;</button>
             <div class="modal-body" id="message-text">
                 </div>
        </div>
    </div>
    <script type="module">
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://vniwugmbpssesxvnoefc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaXd1Z21icHNzZXN4dm5vZWZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwOTU0MzcsImV4cCI6MjA1OTY3MTQzN30.6uTmc7ma4Jd_H5yqN7GZEatFzzUEJS5zgbRRrblT_eU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); 
        const GAME_FILES_BUCKET = 'game-files'; 

        // --- SUPABASE DB/STORAGE/RLS SETUP NOTES ---
        // ** ENSURE THIS IS DONE MANUALLY IN SUPABASE **
        // ... (Previous detailed notes on Tables, RLS, Storage Policies) ...

        // --- Global State ---
        let currentUser = null;
        let currentGameData = null; 
        let currentCategory = '';
        let currentSort = 'created_at.desc';
        const PREVIEW_PLACEHOLDER_URL = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 3'%3E%3Crect width='4' height='3' fill='%23${window.getComputedStyle(document.body).getPropertyValue('--placeholder-bg').substring(1)}'/%3E%3Ctext x='50%25' y='50%25' font-family='<span class="math-inline">\{window\.getComputedStyle\(document\.body\)\.getPropertyValue\('\-\-pixel\-font'\)\.replace\(/'/g, ''\)\}' font\-size\='1px' fill\='%23</span>{window.getComputedStyle(document.body).getPropertyValue('--primary-color').substring(1)}' dominant-baseline='middle' text-anchor='middle'%3E?%3C/text%3E%3C/svg%3E`; 

        // --- DOM Element References --- 
        const views = document.querySelectorAll('.view');
        const modals = document.querySelectorAll('.modal');
        const navLinksContainer = document.getElementById('nav-links');
        const loginLink = document.getElementById('login-link');
        const registerLink = document.getElementById('register-link');
        const logoutButton = document.getElementById('logout-button');
        const requiresLoginElements = document.querySelectorAll('.requires-login');
        const gameGrid = document.getElementById('game-grid');
        const categoryFilter = document.getElementById('category-filter');
        const sortBy = document.getElementById('sort-by');
        const sidebarCategories = document.getElementById('sidebar-categories');
        const gameTitle = document.getElementById('game-title');
        const gameIframe = document.getElementById('game-iframe');
        const gameUploader = document.getElementById('game-uploader');
        const gameCategory = document.getElementById('game-category');
        const gameDescription = document.getElementById('game-description');
        const likeButton = document.getElementById('like-button');
        const likeCount = document.getElementById('like-count');
        const downloadButton = document.getElementById('download-button');
        const reportButton = document.getElementById('report-button');
        const backButton = document.getElementById('back-button');
        const uploadForm = document.getElementById('upload-form');
        const uploadTitle = document.getElementById('upload-title');
        const uploadDescription = document.getElementById('upload-description');
        const uploadCategory = document.getElementById('upload-category');
        const uploadGameFile = document.getElementById('upload-game-file');
        const uploadPreviewImage = document.getElementById('upload-preview-image');
        const uploadSubmitButton = document.getElementById('upload-submit-button');
        const uploadStatus = document.getElementById('upload-status');
        const uploadError = document.getElementById('upload-error');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const reportForm = document.getElementById('report-form');
        const messageModal = document.getElementById('modal-message');
        const messageText = document.getElementById('message-text');
        const termsLink = document.getElementById('terms-link');
        const termsBackButton = document.getElementById('terms-back-button');


        // --- Helper Functions --- 
        function showView(viewId) {
            console.log(`Showing view: ${viewId}`); 
            views.forEach(view => view.classList.remove('active'));
            const activeView = document.getElementById(viewId);
            if (activeView) {
                if (activeView.classList.contains('requires-login') && !currentUser) {
                    if (document.getElementById('modal-login').style.display !== 'block') {
                         showMessage("Please log in or register to access this page.");
                         showModal('login');
                    }
                     const currentActive = document.querySelector('.view.active') || document.getElementById('view-game-list');
                     if (!currentActive) { 
                          document.getElementById('view-game-list').classList.add('active');
                     } else {
                          currentActive.classList.add('active'); 
                     }
                    if (window.location.hash !== '#/login' && window.location.hash !== '#/register') {
                       window.location.hash = '#/'; 
                    }
                    return; 
                }
                activeView.classList.add('active');
            } else {
                console.error(`View with ID ${viewId} not found. Showing game list.`);
                const gameListView = document.getElementById('view-game-list');
                 if(gameListView) gameListView.classList.add('active');
                 window.location.hash = '#/';
            }
            window.scrollTo(0, 0); 
        }

        function showModal(modalId) {
            console.log(`Attempting to show modal with ID: ${modalId}`); 
            const modal = document.getElementById(`modal-${modalId}`);
            console.log('Found modal element:', modal); 
            if (modal) {
                const errorElement = modal.querySelector('.error-message'); 
                if (errorElement) {
                    errorElement.textContent = '';
                    errorElement.classList.add('hidden');
                }
                 const form = modal.querySelector('form');
                 // if(form) form.reset(); 

                modal.style.display = 'block';
                console.log(`Set display=block for modal-${modalId}`); 
            } else {
                console.error(`Modal element not found for ID: modal-${modalId}`); 
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(`modal-${modalId}`);
            if (modal) modal.style.display = 'none';
        }

        function showMessage(message, isError = false) {
            messageText.textContent = message;
            messageText.style.color = isError ? 'var(--error-color)' : 'var(--primary-color)';
            showModal('message'); 
        }

        // --- Authentication --- 
        async function setupAuthListeners() {
            console.log("Setting up auth listeners..."); // Added log
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            if (sessionError) console.error("Error getting initial session:", sessionError);
            currentUser = session?.user ?? null;
            updateUIBasedOnAuth();
            handleRouteChange(); 

            supabaseClient.auth.onAuthStateChange((_event, session) => {
                const previousUser = currentUser?.id;
                currentUser = session?.user ?? null;
                console.log("Auth state changed:", currentUser?.email ?? 'Logged out');
                updateUIBasedOnAuth();
                if (previousUser !== currentUser?.id) {
                    handleRouteChange(); 
                }
            });
             console.log("Auth listeners setup complete."); // Added log
        }

        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const errorElement = document.getElementById('register-error');
            errorElement.classList.add('hidden'); 

             if (password !== passwordConfirm) {
                 errorElement.textContent = "Passwords do not match.";
                 errorElement.classList.remove('hidden');
                 return;
             }
             if (password.length < 6) {
                 errorElement.textContent = "Password must be at least 6 characters.";
                 errorElement.classList.remove('hidden');
                 return;
             }

            try {
                // Redirect URL now uses Supabase site URL setting
                const { data, error } = await supabaseClient.auth.signUp({ email, password }); 
                if (error) throw error;
                hideModal('register');
                showMessage('Registration successful! Please check your email for verification (if enabled).');
            } catch (error) {
                console.error('Registration Error:', error);
                errorElement.textContent = error.message || 'Registration failed.';
                errorElement.classList.remove('hidden');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
             errorElement.classList.add('hidden'); 

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                hideModal('login');
            } catch (error) {
                console.error('Login Error:', error);
                errorElement.textContent = error.message || 'Login failed. Check email/password.';
                errorElement.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                console.log("Attempting logout..."); // Added log
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                console.log("Logout successful."); // Added log
                window.location.hash = '#/'; 
            } catch (error) {
                 console.error('Logout Error:', error);
                 showMessage(`Logout failed: ${error.message}`, true);
            }
        }

        function updateUIBasedOnAuth() {
            console.log("Updating UI for auth state:", currentUser ? currentUser.email : 'Logged out');
            if (currentUser) {
                loginLink.classList.add('hidden');
                registerLink.classList.add('hidden');
                requiresLoginElements.forEach(el => el.classList.remove('hidden'));
                // Enable buttons if element exists
                if(likeButton) likeButton.disabled = false;
                if(downloadButton) downloadButton.disabled = false;
                if(reportButton) reportButton.disabled = false;
            } else {
                loginLink.classList.remove('hidden');
                registerLink.classList.remove('hidden');
                requiresLoginElements.forEach(el => el.classList.add('hidden'));
                 if(likeButton) likeButton.disabled = true;
                 if(downloadButton) downloadButton.disabled = true;
                 if(reportButton) reportButton.disabled = true;
            }
        }


        // --- Game Fetching & Rendering ---
        async function fetchAndRenderGames() {
            gameGrid.innerHTML = '<div class="loading-indicator">Loading games...</div>'; 

            const [sortField, sortOrder] = currentSort.split('.');

            try {
                let query = supabaseClient
                    .from('games')
                    .select('id, title, description, category, preview_image_path, likes_count')
                    .order(sortField, { ascending: sortOrder === 'asc' });

                if (currentCategory) {
                    query = query.eq('category', currentCategory);
                }

                const { data: games, error } = await query.limit(100); 

                if (error) throw error;

                if (games && games.length > 0) {
                    gameGrid.innerHTML = ''; 
                    gameGrid.style.display = 'grid'; 
                    gameGrid.style.textAlign = ''; 
                    games.forEach(renderGameCard);
                } else {
                    gameGrid.style.display = 'block'; 
                    gameGrid.innerHTML = '<p class="no-games-message">No games found matching your criteria.</p>'; 
                }
            } catch (error) {
                 console.error('Error fetching games:', error);
                 gameGrid.style.display = 'block'; 
                 gameGrid.innerHTML = '<p class="no-games-message error-message">Could not load games. Please try again later.</p>';
            }
        }

         function renderGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';
            card.dataset.gameId = game.id;

            const previewUrl = game.preview_image_path
                ? `<span class="math-inline">\{SUPABASE\_URL\}/storage/v1/object/public/</span>{GAME_FILES_BUCKET}/${game.preview_image_path}`
                : PREVIEW_PLACEHOLDER_URL;

            const descriptionPreview = game.description ? game.description.substring(0, 100) + (game.description.length > 100 ? '...' : '') : 'No description.';

            card.innerHTML = `
                <img src="<span class="math-inline">\{previewUrl\}" alt\="</span>{game.title || 'Game'} Preview" class="preview" loading="lazy" onerror="this.src='<span class="math-inline">\{PREVIEW\_PLACEHOLDER\_URL\}'"\> \{/\* Added onerror \*/\}
<h3\></span>{game.title || 'Untitled Game'}</h3>
                <span class="category">${game.category || 'Uncategorized'}</span>
                <p class="likes">Likes: <span class="math-inline">\{game\.likes\_count \|\| 0\}</p\>
<p class\="description\-preview"\></span>{descriptionPreview}</p>
                <button data-game-id="${game.id}" class="view-game-button">Play Game</button>
            `;
            gameGrid.appendChild(card);
        }


        async function fetchAndRenderGameDetails(gameId) {
             showView('view-game-play'); 
             gameTitle.textContent = 'Loading Game...';
             gameIframe.src = 'about:blank'; 
             likeCount.textContent = '...';
             gameDescription.textContent = '...';
             gameUploader.textContent = '...';
             gameCategory.textContent = '...';
             if(likeButton) { likeButton.disabled = true; likeButton.classList.remove('liked'); likeButton.textContent = 'Like'; }
             if(downloadButton) downloadButton.disabled = true;
             if(reportButton) reportButton.disabled = true;
             
             currentGameData = null; 

            try {
                 const { data: game, error: gameError } = await supabaseClient
                     .from('games')
                     .select(`
                         id, title, description, category, uploader_user_id, game_file_path, likes_count,
                         profiles:uploader_user_id ( username ) 
                     `) // Fetch username from profiles if available
                     .eq('id', gameId)
                     .single(); 

                 if (gameError) throw gameError;
                 if (!game) throw new Error("Game not found.");

                 currentGameData = game; 

                 let userHasLiked = false;
                 if (currentUser) {
                     const { data: likeData, error: likeError } = await supabaseClient
                         .from('likes')
                         .select('game_id', { count: 'exact', head: true }) // Just check if like exists
                         .match({ user_id: currentUser.id, game_id: gameId });
                         
                     if (likeError) console.warn("Could not fetch like status:", likeError); 
                     userHasLiked = (likeData?.count ?? 0) > 0; // Check count
                 }

                 gameTitle.textContent = game.title || 'Untitled Game';
                 likeCount.textContent = game.likes_count || 0;
                 gameDescription.textContent = game.description || 'No description provided.';
                 gameUploader.textContent = game.profiles?.username || 'Anonymous'; // Use username if available
                 gameCategory.textContent = game.category || 'Uncategorized';

                 if (currentUser) {
                     if(likeButton) {
                          likeButton.disabled = false;
                          likeButton.classList.toggle('liked', userHasLiked);
                          likeButton.textContent = userHasLiked ? 'Unlike' : 'Like';
                     }
                      if(downloadButton) downloadButton.disabled = false;
                      if(reportButton) reportButton.disabled = false;
                 }

                if (game.game_file_path) {
                    const gameUrl = `<span class="math-inline">\{SUPABASE\_URL\}/storage/v1/object/public/</span>{GAME_FILES_BUCKET}/${game.game_file_path}`;
                    console.log("Loading game iframe:", gameUrl); // Added log
                    gameIframe.src = gameUrl;
                } else {
                     console.error("Game file path missing for game:", gameId); // Added log
                     gameDescription.textContent += "\n\nError: Game file path missing.";
                     gameIframe.src = 'about:blank'; // Ensure blank if path missing
                }

            } catch (error) {
                console.error("Error fetching game details:", error);
                gameTitle.textContent = 'Error Loading Game';
                gameDescription.textContent = `Could not load game details: ${error.message}`;
            }
        }


        // --- Game Actions ---
        async function handleLike() {
            if (!currentUser || !currentGameData) return;
            if (likeButton.disabled) return; 

            likeButton.disabled = true; 
            const gameId = currentGameData.id;
            const currentLikes = parseInt(likeCount.textContent || '0');
            const userIsLiked = likeButton.classList.contains('liked');

            try {
                if (userIsLiked) {
                    const { error } = await supabaseClient
                        .from('likes')
                        .delete()
                        .match({ user_id: currentUser.id, game_id: gameId });
                    if (error) throw error;

                    const { error: rpcError } = await supabaseClient.rpc('decrement_like_count', { game_uuid: gameId });
                    if(rpcError) console.warn("RPC decrement failed:", rpcError); 

                    likeButton.classList.remove('liked');
                    likeButton.textContent = 'Like';
                    likeCount.textContent = Math.max(0, currentLikes - 1);

                } else {
                    const { error } = await supabaseClient
                        .from('likes')
                        .insert({ user_id: currentUser.id, game_id: gameId });
                     if (error) throw error;

                     const { error: rpcError } = await supabaseClient.rpc('increment_like_count', { game_uuid: gameId });
                     if(rpcError) console.warn("RPC increment failed:", rpcError); 

                     likeButton.classList.add('liked');
                     likeButton.textContent = 'Unlike';
                     likeCount.textContent = currentLikes + 1;
                }
            } catch(error) {
                console.error("Error liking/unliking game:", error);
                showMessage(`Action failed: ${error.message}`, true);
                 likeCount.textContent = currentLikes; 
                 likeButton.classList.toggle('liked', userIsLiked); 
                 likeButton.textContent = userIsLiked ? 'Unlike' : 'Like'; 

            } finally {
                 if(currentUser) likeButton.disabled = false; 
            }
        }

        async function handleDownload() {
             if (!currentUser || !currentGameData || !currentGameData.game_file_path) return;

             try {
                 const gameUrl = `<span class="math-inline">\{SUPABASE\_URL\}/storage/v1/object/public/</span>{GAME_FILES_BUCKET}/${currentGameData.game_file_path}`;
                 console.log("Attempting download from:", gameUrl); // Added log

                 const link = document.createElement('a');
                 link.href = gameUrl;
                 const filename = currentGameData.title ? `${currentGameData.title.replace(/[^a-z0-9_\-\s]/gi, '_')}.html` : 'game.html';
                 link.download = filename; 
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);

             } catch (error) {
                 console.error("Error preparing download:", error);
                 showMessage("Could not prepare download link.", true);
             }
        }

        function showReportModal() {
             if (!currentUser || !currentGameData) return;
             hideModal('report'); 
             document.getElementById('report-game-id').value = currentGameData.id;
             showModal('report');
        }

        async function handleReportSubmit(event) {
            event.preventDefault();
            if (!currentUser) return;

            const gameId = document.getElementById('report-game-id').value;
            const reason = document.getElementById('report-reason').value.trim();
            const errorElement = document.getElementById('report-error');
            errorElement.classList.add('hidden');

            if (!reason) {
                 errorElement.textContent = 'Please provide a reason.';
                 errorElement.classList.remove('hidden');
                 return;
            }

            try {
                 const { error } = await supabaseClient
                     .from('reports')
                     .insert({
                         game_id: gameId,
                         reason: reason,
                         reporter_user_id: currentUser.id
                     });
                 if (error) throw error;

                 hideModal('report');
                 showMessage("Report submitted successfully. Thank you.");

            } catch (error) {
                 console.error("Error submitting report:", error);
                 errorElement.textContent = `Failed to submit report: ${error.message}`;
                 errorElement.classList.remove('hidden');
            }
        }

        // --- Uploading ---
         async function handleUpload(event) {
            event.preventDefault();
            if (!currentUser) {
                 showMessage("Please log in to upload.", true);
                 return;
            }

            const title = uploadTitle.value.trim();
            const description = uploadDescription.value.trim();
            const category = uploadCategory.value;
            const gameFile = uploadGameFile.files[0];
            const previewFile = uploadPreviewImage.files[0];

             uploadError.classList.add('hidden'); 

            if (!title || !description || !category || !gameFile) {
                 uploadError.textContent = 'Please fill in all required fields (Title, Description, Category, Game File).';
                 uploadError.classList.remove('hidden');
                 return;
            }
            if (gameFile.type !== 'text/html') {
                uploadError.textContent = 'Game file must be an .html file.';
                uploadError.classList.remove('hidden');
                return;
            }
             if (previewFile && !previewFile.type.startsWith('image/')) {
                 uploadError.textContent = 'Preview file must be an image (JPG, PNG, GIF).';
                 uploadError.classList.remove('hidden');
                 return;
             }

             uploadSubmitButton.disabled = true;
             uploadSubmitButton.textContent = 'Uploading...';
             uploadStatus.textContent = 'Starting upload...';
             uploadStatus.classList.remove('hidden');

             // Generate unique path using timestamp and user ID for better organization
             const timestamp = Date.now();
             const baseFolderPath = `games/<span class="math-inline">\{currentUser\.id\}/</span>{timestamp}`; // Folder per upload
             const gameFileName = `game.html`; // Standard name within folder
             const gameFolderPath = `<span class="math-inline">\{baseFolderPath\}/</span>{gameFileName}`; 

             try {
                 uploadStatus.textContent = 'Uploading game file...';
                 const { data: gameUploadData, error: gameUploadError } = await supabaseClient.storage
                     .from(GAME_FILES_BUCKET)
                     .upload(gameFolderPath, gameFile);

                 if (gameUploadError) throw new Error(`Game file upload failed: ${gameUploadError.message}`);
                 console.log("Game upload success:", gameUploadData);

                let previewImagePath = null;
                if (previewFile) {
                    uploadStatus.textContent = 'Uploading preview image...';
                     const previewFileExt = previewFile.name.split('.').pop();
                     const previewFileName = `preview.${previewFileExt}`;
                     const previewFolderPath = `<span class="math-inline">\{baseFolderPath\}/</span>{previewFileName}`; // Store in same folder

                     const { data: previewUploadData, error: previewUploadError } = await supabaseClient.storage
                         .from(GAME_FILES_BUCKET)
                         .upload(previewFolderPath, previewFile);

                     if (previewUploadError) {
                         console.warn(`Preview image upload failed: ${previewUploadError.message}`);
                         showMessage("Game uploaded, but preview image failed.", true); // Adjusted message
                     } else {
                         previewImagePath = previewFolderPath; 
                         console.log("Preview upload success:", previewUploadData);
                     }
                }

                 uploadStatus.textContent = 'Saving game details...';
                 const { data: gameInsertData, error: gameInsertError } = await supabaseClient
                     .from('games')
                     .insert({
                         title: title,
                         description: description,
                         category: category,
                         uploader_user_id: currentUser.id,
                         game_file_path: gameFolderPath, 
                         preview_image_path: previewImagePath 
                     })
                     .select('id') 
                     .single(); 

                 if (gameInsertError) throw new Error(`Database insert failed: ${gameInsertError.message}`);
                 console.log("Database insert success:", gameInsertData);

                 uploadStatus.textContent = 'Upload Complete!';
                 showMessage("Game uploaded successfully!");
                 uploadForm.reset(); 
                 window.location.hash = `#/game/${gameInsertData.id}`;

             } catch (error) {
                 console.error("Upload process error:", error);
                 uploadError.textContent = `Upload failed: ${error.message}`;
                 uploadError.classList.remove('hidden');
                 uploadStatus.classList.add('hidden');
                 // Consider cleanup logic here if needed
             } finally {
                 uploadSubmitButton.disabled = false;
                 uploadSubmitButton.textContent = 'Upload Game';
             }
        }


        // --- Event Listeners --- 
        function setupEventListeners() {
            console.log("Setting up event listeners..."); 

            if (navLinksContainer) { 
                navLinksContainer.addEventListener('click', (e) => {
                    console.log('Nav link container clicked!'); 
                    const target = e.target.closest('a[data-view], button[data-view], a[data-modal], button[data-modal]');
                    console.log('Clicked target:', target); 

                    if (!target) return;

                    console.log('Target dataset:', target.dataset); 

                    // Allow default hash change for navigation, prevent for modals/logout
                    if (target.dataset.modal || target.id === 'logout-button') {
                       e.preventDefault(); 
                    }

                    if (target.id === 'logout-button') {
                        console.log('Logout button detected'); 
                        handleLogout();
                    } else if (target.dataset.modal) {
                        console.log(`Modal target detected: ${target.dataset.modal}`); 
                        showModal(target.dataset.modal); 
                    } else if (target.dataset.view) {
                        console.log(`View target detected: ${target.dataset.view}`); 
                         // Let hashchange listener handle view change
                    }
                });
            } else { console.error("navLinksContainer not found during listener setup"); }

            document.addEventListener('click', (e) => {
                 if (e.target.classList.contains('modal')) {
                     const modalId = e.target.id.replace('modal-', '');
                     if(modalId) hideModal(modalId);
                 } 
                 else if (e.target.classList.contains('modal-close')) {
                      const modal = e.target.closest('.modal');
                      if(modal) {
                          const modalId = modal.id.replace('modal-', '');
                          if(modalId) hideModal(modalId);
                      }
                 }
             });

            if (loginForm) { loginForm.addEventListener('submit', handleLogin); } else { console.error("loginForm not found"); }
            if (registerForm) { registerForm.addEventListener('submit', handleRegister); } else { console.error("registerForm not found"); }
            if (categoryFilter) { categoryFilter.addEventListener('change', () => { currentCategory = categoryFilter.value; window.location.hash = `#/category/${encodeURIComponent(currentCategory || 'All')}`; }); } else { console.error("categoryFilter not found"); }
             if (sortBy) { sortBy.addEventListener('change', () => { currentSort = sortBy.value; fetchAndRenderGames(); }); } else { console.error("sortBy not found"); }
             if (sidebarCategories) { sidebarCategories.addEventListener('click', (e) => { if (e.target.tagName === 'A' && e.target.dataset.category !== undefined) { e.preventDefault(); window.location.hash = `#/category/${encodeURIComponent(e.target.dataset.category || 'All')}`; }}); } else { console.error("sidebarCategories not found"); }
            if (gameGrid) { gameGrid.addEventListener('click', (e) => { const button = e.target.closest('button.view-game-button'); if (button && button.dataset.gameId) { e.preventDefault(); window.location.hash = `#/game/${button.dataset.gameId}`; }}); } else { console.error("gameGrid not found"); }
            if (backButton) { backButton.addEventListener('click', () => window.location.hash = `#/category/${encodeURIComponent(currentCategory || 'All')}`); } else { console.error("backButton not found"); }
            if (likeButton) { likeButton.addEventListener('click', handleLike); } else { console.error("likeButton not found"); }
             if (downloadButton) { downloadButton.addEventListener('click', handleDownload); } else { console.error("downloadButton not found"); }
             if (reportButton) { reportButton.addEventListener('click', showReportModal); } else { console.error("reportButton not found"); }
             if (reportForm) { reportForm.addEventListener('submit', handleReportSubmit); } else { console.error("reportForm not found"); }
             if (uploadForm) { uploadForm.addEventListener('submit', handleUpload); } else { console.error("uploadForm not found"); }
             if (termsLink) { termsLink.addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#/terms'; }); } else { console.error("termsLink not found"); }
              if (termsBackButton) { termsBackButton.addEventListener('click', () => { window.history.back(); }); } else { console.error("termsBackButton not found"); }
             window.addEventListener('hashchange', handleRouteChange);

             console.log("Event listeners setup complete."); 
        } 


        // --- Initialization ---
        function init() {
            console.log("Initializing AI Game Arcade...");
             try { // Wrap init in try-catch for better error isolation
                 document.getElementById('copyright-year').textContent = new Date().getFullYear();
                 setupEventListeners(); 
                 setupAuthListeners(); 
             } catch (error) {
                  console.error("Error during initialization:", error);
                  // Maybe display a user-friendly error message on the page itself
             }
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>

</body>
</html>