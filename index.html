<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Game Arcade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS Reset & Basic Setup --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --pixel-font: 'Press Start 2P', cursive;
            --bg-color: #000020; /* Deep blue */
            --primary-color: #FFFFFF; /* White */
            --secondary-color: #00FF00; /* Bright Green */
            --accent-color: #FF00FF; /* Magenta */
            --border-color: var(--secondary-color);
            --error-color: #FF3333; /* Red */
            --button-bg: var(--accent-color);
            --button-text: var(--primary-color);
            --card-bg: #111133;
            --input-bg: #222244;
            --link-color: var(--secondary-color);
            --placeholder-bg: #333355; /* Darker placeholder */
        }

        html {
            font-size: 10px; /* Base font size for easier rem calculations */
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--pixel-font);
            background-color: var(--bg-color);
            color: var(--primary-color);
            line-height: 1.6;
            font-size: 1.4rem; /* Default font size */
            padding-bottom: 60px; /* Footer height */
            position: relative;
            min-height: 100vh;
        }

        img {
            max-width: 100%;
            height: auto;
            display: block;
            image-rendering: pixelated; /* Keep pixel art crisp */
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            background-color: var(--placeholder-bg); /* BG for loading/missing */
        }

        a {
            color: var(--link-color);
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        input, textarea, select, button {
            font-family: inherit;
            font-size: inherit;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--primary-color);
            border-radius: 0; /* No rounded corners */
        }
        input:focus, textarea:focus, select:focus {
             outline: 2px solid var(--accent-color);
        }

        button {
            cursor: pointer;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--border-color);
            box-shadow: 3px 3px 0px var(--border-color);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            border-radius: 0; /* No rounded corners */
        }
        button:hover {
             transform: translate(1px, 1px);
             box-shadow: 2px 2px 0px var(--border-color);
        }
        button:active {
             transform: translate(3px, 3px);
             box-shadow: 0px 0px 0px var(--border-color);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            background-color: #555;
            border-color: #777;
        }

        /* --- Layout --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            padding: 20px 0;
            border-bottom: 4px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px; /* Added gap for spacing */
        }

        header h1 {
            font-size: 2.8rem;
            color: var(--secondary-color);
            text-shadow: 2px 2px var(--accent-color);
            margin-right: auto; /* Push nav to the right */
        }

        nav#nav-links a, nav#nav-links button {
            margin-left: 15px;
            font-size: 1.4rem;
            background: none;
            border: none;
            box-shadow: none;
            color: var(--link-color);
            padding: 5px;
        }
         nav#nav-links a:hover, nav#nav-links button:hover {
             text-decoration: underline;
             transform: none;
         }


        .main-content {
            display: flex;
            gap: 20px;
        }

        main {
            flex: 3; /* Takes up most space */
            min-width: 0; /* Prevent flex item overflow */
        }

        aside#sidebar {
            flex: 1;
            border-left: 4px solid var(--border-color);
            padding-left: 20px;
        }
         aside#sidebar h3 {
             margin-bottom: 10px;
             color: var(--secondary-color);
         }
         aside#sidebar ul {
             list-style: none;
             padding: 0;
             margin: 0;
         }
         aside#sidebar li a {
            display: block;
            padding: 5px 0;
            font-size: 1.3rem;
         }

        footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            border-top: 4px solid var(--border-color);
            background-color: var(--bg-color);
            font-size: 1.2rem;
            height: 60px; /* Match body padding-bottom */
        }

        /* --- Views --- */
        .view { display: none; } /* Hide all views by default */
        .view.active { display: block; } /* Show active view */

        /* --- Game List View --- */
        #view-game-list .filters {
            margin-bottom: 20px;
            display: flex;
            gap: 15px; /* Increased gap */
            align-items: center;
            flex-wrap: wrap;
        }
         #view-game-list .filters label {
             margin-right: 5px;
         }

        #game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); /* Slightly smaller min size */
            gap: 25px; /* Increased gap */
        }

        .game-card {
            border: 3px solid var(--border-color);
            padding: 15px;
            background-color: var(--card-bg);
            box-shadow: 4px 4px 0px var(--secondary-color);
            display: flex;
            flex-direction: column;
        }
        .game-card img.preview {
            width: 100%;
            aspect-ratio: 4 / 3;
            object-fit: cover; /* Changed to cover */
            background-color: var(--placeholder-bg);
            margin-bottom: 10px;
            border: 2px solid var(--border-color);
            display: block;
        }
        .game-card h3 {
            font-size: 1.5rem; /* Adjusted size */
            margin-bottom: 5px;
            color: var(--secondary-color);
            overflow-wrap: break-word; /* Prevent long titles breaking layout */
            word-break: break-all; /* Allow breaking long words */
             min-height: 3em; /* Reserve space for ~2 lines title */
        }
        .game-card .category {
            font-size: 1.1rem;
            color: var(--accent-color);
            margin-bottom: 8px; /* Increased space */
            display: block;
        }
        .game-card .likes {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
         .game-card .description-preview {
             font-size: 1.2rem;
             margin-bottom: 10px;
             flex-grow: 1; /* Push button to bottom */
             color: #ccc;
             /* Limit description lines */
             display: -webkit-box;
             -webkit-line-clamp: 3;
             -webkit-box-orient: vertical;
             overflow: hidden;
             text-overflow: ellipsis;
             min-height: 4.8em; /* Reserve space for 3 lines */
         }

        .game-card button {
             align-self: flex-start; /* Align button left */
        }

        /* --- Game Play View --- */
         #view-game-play button#back-button { margin-bottom: 15px; }
        #view-game-play #game-title {
            font-size: 2.4rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
            word-break: break-all;
        }
        #game-iframe-container {
            position: relative;
            width: 100%;
            height: 60vh; /* Adjust height */
            margin-bottom: 15px;
            background-color: #000;
            border: 4px solid var(--border-color);
        }
        #game-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background-color: #000; /* Black background while loading */
        }
         #game-details { margin-bottom: 15px; }
         #game-details p {
             margin-bottom: 10px;
             word-break: break-word;
         }
         #game-details p span {
             color: var(--secondary-color); /* Highlight detail values */
         }
        #game-actions button {
            margin-right: 10px;
            margin-bottom: 10px; /* Spacing on mobile */
        }
         #like-button.liked {
             background-color: var(--secondary-color);
             color: var(--bg-color);
             box-shadow: 3px 3px 0px var(--accent-color);
         }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%;
        }
        .form-group textarea {
             min-height: 100px;
             resize: vertical;
        }
         .form-group input[type="file"] {
             background-color: transparent;
             border: none;
             padding: 5px 0; /* Adjusted padding */
         }
         .form-group input[type="file"]::file-selector-button {
              font-family: inherit;
              font-size: inherit;
              padding: 8px 12px;
              border: 2px solid var(--border-color);
              background-color: var(--button-bg);
              color: var(--button-text);
              cursor: pointer;
              box-shadow: 3px 3px 0px var(--border-color);
              margin-right: 10px; /* Space between button and text */
              border-radius: 0;
         }
         .form-group input[type="file"]::file-selector-button:hover {
             transform: translate(1px, 1px);
             box-shadow: 2px 2px 0px var(--border-color);
         }


        /* --- Modals --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 20, 0.8); /* Use BG color with alpha */
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 10% auto;
            padding: 25px;
            border: 4px solid var(--border-color);
            width: 85%; /* Slightly wider */
            max-width: 500px;
            position: relative;
            box-shadow: 6px 6px 0px var(--accent-color);
        }
        .modal-close {
            position: absolute;
            top: 5px;
            right: 15px;
            color: var(--primary-color);
            font-size: 3rem;
            font-weight: bold;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0; /* Remove padding */
        }
        .modal-close:hover, .modal-close:focus {
             color: var(--accent-color);
             transform: none; /* Prevent button style shift */
             box-shadow: none;
        }
         .modal h2 {
             margin-bottom: 15px;
             color: var(--secondary-color);
             font-size: 2rem; /* Adjusted size */
         }
         #modal-message .modal-body {
             font-size: 1.6rem;
             text-align: center;
             min-height: 50px;
             display: flex;
             align-items: center;
             justify-content: center;
             word-break: break-word;
         }

        /* --- Terms View --- */
         #view-terms {
             border: 3px solid var(--border-color);
             padding: 20px;
             background-color: var(--card-bg);
             max-height: 70vh;
             overflow-y: auto;
         }
          #view-terms button#terms-back-button { margin-bottom: 15px; }
         #view-terms h2 {
             color: var(--secondary-color);
             margin-bottom: 15px;
         }
          #view-terms h3 {
             color: var(--accent-color);
             margin-bottom: 10px;
             margin-top: 15px;
         }
          #view-terms ul { margin-left: 20px; margin-bottom: 10px; }


        /* --- Ad Slots --- */
        .ad-slot {
            border: 2px dashed var(--accent-color);
            padding: 10px;
            margin: 20px 0; /* Use margin for spacing */
            min-height: 100px; /* Example minimum height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: var(--input-bg);
            width: 100%; /* Ensure full width */
        }
         #ad-slot-header { min-height: 90px; }
         #ad-slot-sidebar { min-height: 250px; margin-top: 0; } /* Taller sidebar ad */

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .error-message { color: var(--error-color); font-size: 1.2rem; margin-top: 5px; display: block; /* Ensure it takes space */ }
        .loading-indicator { text-align: center; font-size: 1.8rem; padding: 30px; color: var(--secondary-color); }
        .sr-only { /* Screen reader only text */
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }


        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            aside#sidebar {
                border-left: none;
                border-top: 4px solid var(--border-color);
                padding-left: 0;
                padding-top: 20px;
            }
             header { flex-direction: column; align-items: stretch; }
            header h1 { text-align: center; margin-right: 0; margin-bottom: 10px; }
            nav#nav-links { text-align: center; margin-bottom: 10px; } /* Add spacing below nav */
            nav#nav-links a, nav#nav-links button { margin: 0 8px; }
             #ad-slot-header { order: 3; } /* Keep ad below nav */

            .modal-content { width: 90%; margin: 15% auto;}
            #game-iframe-container { height: 50vh; } /* Adjust iframe height on mobile */
        }
         @media (max-width: 480px) {
             html { font-size: 9px; } /* Adjust base for smaller screens */
             #game-grid {
                 grid-template-columns: 1fr; /* Single column */
                 gap: 15px;
             }
             header h1 { font-size: 2rem; } /* Adjusted size */
             nav#nav-links a, nav#nav-links button { font-size: 1.4rem; } /* Adjusted size */
             button { padding: 8px 10px; } /* Adjusted padding */
             #view-game-play #game-title { font-size: 2rem; }
         }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><a href="#/" style="color: inherit; text-decoration: none;">AI Game Arcade</a></h1>
            <nav id="nav-links">
                <a href="#/" data-view="game-list">Home</a>
                <a href="#/upload" data-view="upload-form" class="requires-login hidden">Upload</a>
                <a href="#/login" id="login-link" data-modal="login">Login</a>
                <a href="#/register" id="register-link" data-modal="register">Register</a>
                <button id="logout-button" class="requires-login hidden">Logout</button>
            </nav>
             <div id="ad-slot-header" class="ad-slot">
                 <p>ADVERTISEMENT - HEADER<br>(728x90 recommended)<br>(Replace this with your ad code/image)</p>
             </div>
             </header>

        <div class="main-content">
            <main>
                <div id="view-game-list" class="view active">
                    <h2>Browse Games</h2>
                    <div class="filters">
                         <label for="category-filter">Category:</label>
                         <select id="category-filter">
                             <option value="">All</option>
                             <option value="Action">Action</option>
                             <option value="Puzzle">Puzzle</option>
                             <option value="Adventure">Adventure</option>
                             <option value="Arcade">Arcade</option>
                             <option value="Simulation">Simulation</option>
                             <option value="Other">Other</option>
                         </select>
                         <label for="sort-by">Sort By:</label>
                         <select id="sort-by">
                             <option value="created_at.desc">Newest</option>
                             <option value="likes_count.desc">Most Liked</option>
                             <option value="title.asc">Title (A-Z)</option>
                         </select>
                    </div>
                    <div id="game-grid" class="loading-indicator">Loading games...</div>
                </div>

                <div id="view-game-play" class="view">
                    <button id="back-button">&lt; Back to List</button>
                    <h2 id="game-title">Loading Game...</h2>
                    <div id="game-iframe-container">
                        <iframe id="game-iframe" sandbox="allow-scripts allow-same-origin" title="Game Area" src="about:blank"></iframe>
                        </div>
                    <div id="game-details">
                        <p>Uploader: <span id="game-uploader">...</span></p>
                        <p>Category: <span id="game-category">...</span></p>
                        <p>Description:</p>
                        <p id="game-description">...</p>
                    </div>
                    <div id="game-actions">
                        <button id="like-button" class="requires-login hidden" disabled><span class="sr-only">Like status: </span>Like</button>
                        <span>Likes: <span id="like-count">0</span></span>
                        <button id="download-button" class="requires-login hidden" disabled>Download</button>
                        <button id="report-button" class="requires-login hidden" disabled>Report</button>
                    </div>
                </div>

                <div id="view-upload-form" class="view requires-login hidden">
                    <h2>Upload Your Game</h2>
                    <form id="upload-form">
                        <div class="form-group">
                            <label for="upload-title">Game Title:</label>
                            <input type="text" id="upload-title" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="upload-description">Description:</label>
                            <textarea id="upload-description" required maxlength="500"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="upload-category">Category:</label>
                            <select id="upload-category" required>
                                <option value="" disabled selected>Select a category...</option>
                                <option value="Action">Action</option>
                                <option value="Puzzle">Puzzle</option>
                                <option value="Adventure">Adventure</option>
                                <option value="Arcade">Arcade</option>
                                <option value="Simulation">Simulation</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="upload-game-file">Game File (.html only):</label>
                            <input type="file" id="upload-game-file" accept=".html" required>
                        </div>
                        <div class="form-group">
                            <label for="upload-preview-image">Preview Image (Optional, JPG/PNG/GIF):</label>
                            <input type="file" id="upload-preview-image" accept="image/*">
                        </div>
                        <button type="submit" id="upload-submit-button">Upload Game</button>
                        <p id="upload-status" class="loading-indicator hidden"></p>
                        <p id="upload-error" class="error-message hidden"></p>
                    </form>
                </div>

                 <div id="view-terms" class="view">
                     <button id="terms-back-button">&lt; Back</button>
                     <h2>Terms of Service & Content Policy</h2>

                    <p><strong>Welcome to AI Game Arcade!</strong></p>

                    <p>This site allows users to share and play single-file games, often created with the help of AI. By using this site (Browse, uploading, downloading, liking, or registering), you agree to these terms.</p>

                    <h3>1. User Accounts:</h3>
                    <ul>
                        <li>You need to register an account to upload, download, or like games.</li>
                        <li>You are responsible for keeping your account information secure.</li>
                        <li>Browse games does not require registration.</li>
                    </ul>

                    <h3>2. Content Uploads:</h3>
                    <ul>
                        <li>You may only upload single-file games (primarily `.html` format) that you have the right to share.</li>
                        <li>You grant AI Game Arcade a license to host, display, and allow users to play and download your uploaded games.</li>
                        <li>You are responsible for the content you upload.</li>
                    </ul>

                    <h3>3. Prohibited Content:</h3>
                    <ul>
                        <li>Do not upload content that is illegal, hateful, harassing, threatening, pornographic, excessively violent, or infringes on copyright or intellectual property.</li>
                        <li>Do not upload malicious code (viruses, spyware, etc.). All games run in a sandboxed environment for security, but malicious intent is forbidden.</li>
                    </ul>

                    <h3>4. Playing Games:</h3>
                    <ul>
                        <li>Games are provided by other users "as is". AI Game Arcade does not guarantee the quality, functionality, or safety of user-uploaded games, although we use sandboxing for security. Play at your own discretion.</li>
                    </ul>

                    <h3>5. Reporting Content:</h3>
                    <ul>
                        <li>You can report games you believe violate these terms using the "Report" feature. Please provide a clear reason.</li>
                        <li>AI Game Arcade reserves the right to review reported content and remove any content at its sole discretion, without notice.</li>
                    </ul>

                    <h3>6. Advertising:</h3>
                    <ul>
                        <li>This site may display advertising to support its operation.</li>
                    </ul>

                    <h3>7. Disclaimers:</h3>
                    <ul>
                        <li>AI Game Arcade is provided "as is". We make no warranties regarding site uptime or data retention.</li>
                        <li>We reserve the right to modify or discontinue the service at any time.</li>
                    </ul>

                     <h3>8. Governing Law:</h3>
                     <ul>
                         <li>These terms shall be governed by the laws of Israel.</li>
                     </ul>

                    <p><strong>By using this site, you acknowledge and agree to these terms.</strong></p>
                    </div>

            </main>

            <aside id="sidebar">
                <h3>Categories</h3>
                <ul id="sidebar-categories">
                   <li><a href="#/category/All" data-category="">All</a></li>
                   <li><a href="#/category/Action" data-category="Action">Action</a></li>
                   <li><a href="#/category/Puzzle" data-category="Puzzle">Puzzle</a></li>
                   <li><a href="#/category/Adventure" data-category="Adventure">Adventure</a></li>
                   <li><a href="#/category/Arcade" data-category="Arcade">Arcade</a></li>
                   <li><a href="#/category/Simulation" data-category="Simulation">Simulation</a></li>
                   <li><a href="#/category/Other" data-category="Other">Other</a></li>
                </ul>
                <hr style="border: none; border-top: 2px solid var(--border-color); margin: 20px 0;">
                 <div id="ad-slot-sidebar" class="ad-slot">
                     <p>ADVERTISEMENT - SIDEBAR<br>(e.g., 300x250)<br>(Replace this with your ad code/image)</p>
                 </div>
                 </aside>
        </div>

        <footer>
            <p>&copy; <span id="copyright-year"></span> AI Game Arcade. All rights reserved.</p>
            <a href="#/terms" id="terms-link">Terms of Service</a>
        </footer>
    </div> <div id="modal-login" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-modal="login">&times;</button>
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" required autocomplete="current-password">
                </div>
                <button type="submit">Login</button>
                <p id="login-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <div id="modal-register" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-modal="register">&times;</button>
            <h2>Register</h2>
            <form id="register-form">
                <div class="form-group">
                    <label for="register-email">Email:</label>
                    <input type="email" id="register-email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password (min 6 chars):</label>
                    <input type="password" id="register-password" required minlength="6" autocomplete="new-password">
                </div>
                 <div class="form-group">
                     <label for="register-password-confirm">Confirm Password:</label>
                     <input type="password" id="register-password-confirm" required minlength="6" autocomplete="new-password">
                 </div>
                <button type="submit">Register</button>
                <p id="register-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <div id="modal-report" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-modal="report">&times;</button>
            <h2>Report Game</h2>
            <form id="report-form">
                <input type="hidden" id="report-game-id">
                <div class="form-group">
                    <label for="report-reason">Reason for reporting:</label>
                    <textarea id="report-reason" required maxlength="500"></textarea>
                </div>
                <button type="submit">Submit Report</button>
                <p id="report-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>

     <div id="modal-message" class="modal">
        <div class="modal-content">
            <button class="modal-close" data-modal="message">&times;</button>
             <div class="modal-body" id="message-text">
                 </div>
        </div>
    </div>

    <script type="module">
       // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://vniwugmbpssesxvnoefc.supabase.co'; // Correct URL ending
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaXd1Z21icHNzZXN4dm5vZWZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwOTU0MzcsImV4cCI6MjA1OTY3MTQzN30.6uTmc7ma4Jd_H5yqN7GZEatFzzUEJS5zgbRRrblT_eU'; // Your key stays the same
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // Use 'supabase.createClient' here
        const GAME_FILES_BUCKET = 'game-files'; // ** MAKE SURE BUCKET NAME MATCHES **

        // --- SUPABASE DB/STORAGE/RLS SETUP NOTES ---
        // ** YOU NEED TO DO THIS MANUALLY IN YOUR SUPABASE PROJECT DASHBOARD **
        // 1. Database Tables:
        //    - `games` table:
        //        Columns: id (uuid, pk, default uuid_generate_v4()), created_at (timestampz, default now()), title (text, not null), description (text), category (text), uploader_user_id (uuid, fk references auth.users, not null), game_file_path (text, not null), preview_image_path (text, nullable), likes_count (int4, default 0, not null)
        //        RLS: Enable RLS. Policy "Allow public read access": `SELECT` for `all users`. Policy "Allow authenticated users insert": `INSERT` for `authenticated` with check `auth.uid() = uploader_user_id`. Policy "Allow owner delete": `DELETE` for `authenticated` with check `auth.uid() = uploader_user_id`. Policy "Allow like count update": `UPDATE` for `authenticated` (or better, use RPC). Add indexes on `category`, `likes_count`, `created_at`.
        //    - `likes` table:
        //        Columns: user_id (uuid, pk, fk references auth.users), game_id (uuid, pk, fk references games on delete cascade)
        //        RLS: Enable RLS. Policy "Allow individual read access": `SELECT` for `authenticated` with check `auth.uid() = user_id`. Policy "Allow individual insert access": `INSERT` for `authenticated` with check `auth.uid() = user_id`. Policy "Allow individual delete access": `DELETE` for `authenticated` with check `auth.uid() = user_id`.
        //    - `reports` table:
        //        Columns: id (uuid, pk, default uuid_generate_v4()), created_at (timestampz, default now()), game_id (uuid, fk references games on delete set null), reason (text, not null), reporter_user_id (uuid, fk references auth.users, not null)
        //        RLS: Enable RLS. Policy "Allow authenticated users insert": `INSERT` for `authenticated` with check `auth.uid() = reporter_user_id`. Policy "Disallow public select": No SELECT policy for `all users`. Admin access via dashboard.
        // 2. Storage Bucket:
        //    - Create a bucket named `game-files` (or match GAME_FILES_BUCKET const).
        //    - **Set access policy:** IMPORTANT! Go to Bucket Settings -> Policies. Create policies:
        //        - Policy for public read access on game files/previews (simplest V1): Allows `SELECT` for `anon` and `authenticated` roles on objects within 'games/' and 'previews/' folders.
        //        - Policy for authenticated uploads: Allows `INSERT`, `UPDATE` for `authenticated` role, perhaps restricted to specific paths or based on user ID if needed (more complex). Check Supabase docs for secure file upload policies tied to RLS.
        // 3. Auth:
        //    - Email/Password provider enabled. Disable email confirmation if desired for easier testing, but enable for production.
        // 4. RPC Function (Optional but Recommended for Likes):
        //    - Go to Database -> Functions -> Create Function.
        //    - Name: `increment_like_count`. Args: `game_uuid uuid`. Return type: `void`. Definition: `UPDATE public.games SET likes_count = likes_count + 1 WHERE id = game_uuid;`. Security: `DEFINER`. Enable via SQL: `ALTER FUNCTION increment_like_count(uuid) SECURITY DEFINER;`
        //    - Name: `decrement_like_count`. Args: `game_uuid uuid`. Return type: `void`. Definition: `UPDATE public.games SET likes_count = GREATEST(0, likes_count - 1) WHERE id = game_uuid;`. Security: `DEFINER`. Enable via SQL: `ALTER FUNCTION decrement_like_count(uuid) SECURITY DEFINER;`
        // --- END SETUP NOTES ---


        // --- Global State ---
        let currentUser = null;
        let currentGameData = null; // Store full data of the currently viewed game
        let currentCategory = '';
        let currentSort = 'created_at.desc';
        const PREVIEW_PLACEHOLDER_URL = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 3'%3E%3Crect width='4' height='3' fill='%23${window.getComputedStyle(document.body).getPropertyValue('--placeholder-bg').substring(1)}'/%3E%3Ctext x='50%25' y='50%25' font-family='${window.getComputedStyle(document.body).getPropertyValue('--pixel-font')}' font-size='1px' fill='%23${window.getComputedStyle(document.body).getPropertyValue('--primary-color').substring(1)}' dominant-baseline='middle' text-anchor='middle'%3E?%3C/text%3E%3C/svg%3E`; // Simple SVG placeholder


        // --- DOM Element References (already defined in previous thought block) ---
        // Assuming all refs from the <style> thought block are correct
	const navLinksContainer = document.getElementById('nav-links');
	 
      // --- DOM Element References ---
    const loginForm = document.getElementById('login-form'); // You have this
    const views = document.querySelectorAll('.view'); // You have this
    const modals = document.querySelectorAll('.modal'); // You have this

    // Add all of these:
    const navLinksContainer = document.getElementById('nav-links'); // Should be here from before
    const loginLink = document.getElementById('login-link');
    const registerLink = document.getElementById('register-link');
    const logoutButton = document.getElementById('logout-button');
    const requiresLoginElements = document.querySelectorAll('.requires-login');
    const gameGrid = document.getElementById('game-grid');
    const categoryFilter = document.getElementById('category-filter');
    const sortBy = document.getElementById('sort-by');
    const sidebarCategories = document.getElementById('sidebar-categories');

    // Game Play View Elements
    const gameTitle = document.getElementById('game-title');
    const gameIframe = document.getElementById('game-iframe');
    const gameUploader = document.getElementById('game-uploader');
    const gameCategory = document.getElementById('game-category');
    const gameDescription = document.getElementById('game-description');
    const likeButton = document.getElementById('like-button');
    const likeCount = document.getElementById('like-count');
    const downloadButton = document.getElementById('download-button');
    const reportButton = document.getElementById('report-button');
    const backButton = document.getElementById('back-button');

    // Upload Form Elements
    const uploadForm = document.getElementById('upload-form');
    const uploadTitle = document.getElementById('upload-title');
    const uploadDescription = document.getElementById('upload-description');
    const uploadCategory = document.getElementById('upload-category');
    const uploadGameFile = document.getElementById('upload-game-file');
    const uploadPreviewImage = document.getElementById('upload-preview-image');
    const uploadSubmitButton = document.getElementById('upload-submit-button');
    const uploadStatus = document.getElementById('upload-status');
    const uploadError = document.getElementById('upload-error');

    // Other Forms / Modals
    const registerForm = document.getElementById('register-form');
    const reportForm = document.getElementById('report-form');
    const messageModal = document.getElementById('modal-message');
    const messageText = document.getElementById('message-text');

    // --- Helper Functions --- // <--- Make sure this comes AFTER all the const definitions above
    // ... (showView, showModal, etc.) ...

	
	
	

        // showModal, hideModal (defined earlier)

        

        function updateUIBasedOnAuth() {
            console.log("Updating UI for auth state:", currentUser ? currentUser.email : 'Logged out');
            if (currentUser) {
                loginLink.classList.add('hidden');
                registerLink.classList.add('hidden');
                requiresLoginElements.forEach(el => el.classList.remove('hidden'));
                // Enable buttons that might have been disabled
                likeButton.disabled = false;
                downloadButton.disabled = false;
                reportButton.disabled = false;
            } else {
                loginLink.classList.remove('hidden');
                registerLink.classList.remove('hidden');
                requiresLoginElements.forEach(el => el.classList.add('hidden'));
                 // Disable buttons requiring login when logged out
                likeButton.disabled = true;
                downloadButton.disabled = true;
                reportButton.disabled = true;
            }
        }

        // --- Routing ---
        function handleRouteChange() {
            const hash = window.location.hash || '#/';
            console.log("Route changed:", hash);

            // Close any open modals on route change
            modals.forEach(modal => modal.style.display = 'none');

            if (hash.startsWith('#/game/')) {
                const gameId = hash.substring(7);
                fetchAndRenderGameDetails(gameId);
            } else if (hash === '#/upload') {
                showView('view-upload-form');
                // Reset form if revisited
                 uploadForm.reset();
                 uploadStatus.classList.add('hidden');
                 uploadError.classList.add('hidden');
                 uploadSubmitButton.disabled = false;
                 uploadSubmitButton.textContent = 'Upload Game';

            } else if (hash === '#/terms') {
                 showView('view-terms');
            } else if (hash.startsWith('#/category/')) {
                 const category = decodeURIComponent(hash.substring(11));
                 currentCategory = (category === 'All' || category === '') ? '' : category;
                 categoryFilter.value = currentCategory; // Update filter dropdown
                 fetchAndRenderGames(); // Will use currentCategory and currentSort
                 showView('view-game-list');
            } else if (hash === '#/login') {
                showView('view-game-list'); // Show home view in background
                showModal('login');
            } else if (hash === '#/register') {
                 showView('view-game-list'); // Show home view in background
                 showModal('register');
            }
            else { // Default to game list
                currentCategory = ''; // Reset category on home view
                categoryFilter.value = '';
                fetchAndRenderGames();
                showView('view-game-list');
            }
        }


        // --- Authentication ---
        async function setupAuthListeners() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentUser = session?.user ?? null;
            updateUIBasedOnAuth();
            handleRouteChange(); // Initial route handling after auth check

            supabaseClient.auth.onAuthStateChange((_event, session) => {
                const previousUser = currentUser?.id;
                currentUser = session?.user ?? null;
                console.log("Auth state changed:", currentUser?.email ?? 'Logged out');
                updateUIBasedOnAuth();
                 // Avoid unnecessary re-renders if user hasn't changed substantially
                 // Refresh views only if login status changes or navigating to protected route
                if (previousUser !== currentUser?.id) {
                    handleRouteChange(); // Re-evaluate route based on new auth state
                }
            });
        }

        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const errorElement = document.getElementById('register-error');
            errorElement.classList.add('hidden'); // Clear previous errors

             if (password !== passwordConfirm) {
                 errorElement.textContent = "Passwords do not match.";
                 errorElement.classList.remove('hidden');
                 return;
             }
             if (password.length < 6) {
                 errorElement.textContent = "Password must be at least 6 characters.";
                 errorElement.classList.remove('hidden');
                 return;
             }

            try {
                const { data, error } = await supabaseClient.auth.signUp({ email, password });
                if (error) throw error;
                hideModal('register');
                // Consider disabling email confirmation in Supabase Auth settings for easier testing
                showMessage('Registration successful! Please check your email for verification (if enabled).');
            } catch (error) {
                console.error('Registration Error:', error);
                errorElement.textContent = error.message || 'Registration failed.';
                errorElement.classList.remove('hidden');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
             errorElement.classList.add('hidden'); // Clear previous errors

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                hideModal('login');
                // Auth listener will handle UI update and route change
            } catch (error) {
                console.error('Login Error:', error);
                errorElement.textContent = error.message || 'Login failed. Check email/password.';
                errorElement.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                // Auth listener handles UI update and route change
                window.location.hash = '#/'; // Go to home on logout
            } catch (error) {
                 console.error('Logout Error:', error);
                 showMessage(`Logout failed: ${error.message}`, true);
            }
        }


        // --- Game Fetching & Rendering ---
        async function fetchAndRenderGames() {
            gameGrid.innerHTML = '<div class="loading-indicator">Loading games...</div>'; // Show loading state

            const [sortField, sortOrder] = currentSort.split('.');

            try {
                let query = supabaseClient
                    .from('games')
                    .select('id, title, description, category, preview_image_path, likes_count')
                    .order(sortField, { ascending: sortOrder === 'asc' });

                if (currentCategory) {
                    query = query.eq('category', currentCategory);
                }

                const { data: games, error } = await query.limit(100); // Limit results for performance

                if (error) throw error;

                if (games && games.length > 0) {
                    gameGrid.innerHTML = ''; // Clear loading state
                    games.forEach(renderGameCard);
                } else {
                    gameGrid.innerHTML = '<p>No games found matching your criteria.</p>';
                }
            } catch (error) {
                 console.error('Error fetching games:', error);
                 gameGrid.innerHTML = '<p class="error-message">Could not load games. Please try again later.</p>';
            }
        }

        function renderGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';
            card.dataset.gameId = game.id;

            const previewUrl = game.preview_image_path
                ? `${SUPABASE_URL}/storage/v1/object/public/${GAME_FILES_BUCKET}/${game.preview_image_path}`
                : PREVIEW_PLACEHOLDER_URL;

            // Truncate description for preview
            const descriptionPreview = game.description ? game.description.substring(0, 100) + (game.description.length > 100 ? '...' : '') : 'No description.';


            card.innerHTML = `
                <img src="${previewUrl}" alt="${game.title} Preview" class="preview" loading="lazy">
                <h3>${game.title || 'Untitled Game'}</h3>
                <span class="category">${game.category || 'Uncategorized'}</span>
                <p class="likes">Likes: ${game.likes_count || 0}</p>
                <p class="description-preview">${descriptionPreview}</p>
                <button data-game-id="${game.id}" class="view-game-button">Play Game</button>
            `;
            gameGrid.appendChild(card);
        }


        async function fetchAndRenderGameDetails(gameId) {
             showView('view-game-play'); // Show the view first
             gameTitle.textContent = 'Loading Game...';
             gameIframe.src = 'about:blank'; // Clear previous game
             likeCount.textContent = '...';
             gameDescription.textContent = '...';
             gameUploader.textContent = '...';
             gameCategory.textContent = '...';
             likeButton.disabled = true;
             downloadButton.disabled = true;
             reportButton.disabled = true;
             likeButton.classList.remove('liked');
             likeButton.textContent = 'Like';


             currentGameData = null; // Clear previous game data

            try {
                 // Fetch game details
                 const { data: game, error: gameError } = await supabaseClient
                     .from('games')
                     .select(`
                         id,
                         title,
                         description,
                         category,
                         uploader_user_id,
                         game_file_path,
                         likes_count,
                         users:uploader_user_id ( email )
                     `) // Fetch uploader email too
                     .eq('id', gameId)
                     .single(); // Expect only one result

                 if (gameError) throw gameError;
                 if (!game) throw new Error("Game not found.");

                 currentGameData = game; // Store current game data

                 // Fetch user's like status if logged in
                 let userHasLiked = false;
                 if (currentUser) {
                     const { data: likeData, error: likeError } = await supabaseClient
                         .from('likes')
                         .select('game_id')
                         .eq('user_id', currentUser.id)
                         .eq('game_id', gameId)
                         .maybeSingle(); // Might return null if not liked

                     if (likeError) console.warn("Could not fetch like status:", likeError); // Non-critical error
                     userHasLiked = !!likeData;
                 }

                 // Update UI
                 gameTitle.textContent = game.title || 'Untitled Game';
                 likeCount.textContent = game.likes_count || 0;
                 gameDescription.textContent = game.description || 'No description provided.';
                 // Display only part of the uploader's email for privacy
                 gameUploader.textContent = game.users?.email ? game.users.email.split('@')[0] : 'Anonymous';
                 gameCategory.textContent = game.category || 'Uncategorized';

                 // Enable buttons if logged in
                 if (currentUser) {
                     likeButton.disabled = false;
                     downloadButton.disabled = false;
                     reportButton.disabled = false;
                     if (userHasLiked) {
                         likeButton.classList.add('liked');
                         likeButton.textContent = 'Unlike';
                     } else {
                         likeButton.classList.remove('liked');
                         likeButton.textContent = 'Like';
                     }
                 }

                 // Construct game URL and load iframe
                if (game.game_file_path) {
                    const gameUrl = `${SUPABASE_URL}/storage/v1/object/public/${GAME_FILES_BUCKET}/${game.game_file_path}`;
                    gameIframe.src = gameUrl;
                } else {
                    gameDescription.textContent += "\n\nError: Game file path missing.";
                }


            } catch (error) {
                console.error("Error fetching game details:", error);
                gameTitle.textContent = 'Error Loading Game';
                gameDescription.textContent = `Could not load game details: ${error.message}`;
                 // Consider redirecting back or showing error message
                 // showMessage(`Error loading game: ${error.message}`, true);
                 // showView('view-game-list');
            }
        }


        // --- Game Actions ---
        async function handleLike() {
            if (!currentUser || !currentGameData) return;
            if (likeButton.disabled) return; // Prevent double clicks

            likeButton.disabled = true; // Disable during operation
            const gameId = currentGameData.id;
            const currentLikes = parseInt(likeCount.textContent || '0');
            const userIsLiked = likeButton.classList.contains('liked');

            try {
                if (userIsLiked) {
                    // Unlike
                    const { error } = await supabaseClient
                        .from('likes')
                        .delete()
                        .match({ user_id: currentUser.id, game_id: gameId });
                    if (error) throw error;

                    // Decrement count using RPC function (optional but recommended)
                    const { error: rpcError } = await supabaseClient.rpc('decrement_like_count', { game_uuid: gameId });
                    if(rpcError) console.warn("RPC decrement failed:", rpcError); // Log but continue UI update

                    likeButton.classList.remove('liked');
                    likeButton.textContent = 'Like';
                    likeCount.textContent = Math.max(0, currentLikes - 1);

                } else {
                    // Like
                    const { error } = await supabaseClient
                        .from('likes')
                        .insert({ user_id: currentUser.id, game_id: gameId });
                     if (error) throw error;

                    // Increment count using RPC function (optional but recommended)
                     const { error: rpcError } = await supabaseClient.rpc('increment_like_count', { game_uuid: gameId });
                     if(rpcError) console.warn("RPC increment failed:", rpcError); // Log but continue UI update

                     likeButton.classList.add('liked');
                     likeButton.textContent = 'Unlike';
                     likeCount.textContent = currentLikes + 1;
                }
            } catch(error) {
                console.error("Error liking/unliking game:", error);
                showMessage(`Action failed: ${error.message}`, true);
                 // Revert UI optimistically or re-fetch state
                 likeCount.textContent = currentLikes; // Revert count
                 likeButton.classList.toggle('liked', userIsLiked); // Revert class
                 likeButton.textContent = userIsLiked ? 'Unlike' : 'Like'; // Revert text

            } finally {
                 if(currentUser) likeButton.disabled = false; // Re-enable only if still logged in
            }
        }

        async function handleDownload() {
             if (!currentUser || !currentGameData || !currentGameData.game_file_path) return;

             try {
                 const gameUrl = `${SUPABASE_URL}/storage/v1/object/public/${GAME_FILES_BUCKET}/${currentGameData.game_file_path}`;

                 // Create a temporary link to trigger download
                 const link = document.createElement('a');
                 link.href = gameUrl;
                 // Suggest a filename (browser might override)
                 const filename = currentGameData.title ? `${currentGameData.title.replace(/[^a-z0-9_\-\s]/gi, '_')}.html` : 'game.html';
                 link.download = filename;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);

             } catch (error) {
                 console.error("Error preparing download:", error);
                 showMessage("Could not prepare download link.", true);
             }
        }

        function showReportModal() {
             if (!currentUser || !currentGameData) return;
             hideModal('report'); // Clear previous state if any
             document.getElementById('report-game-id').value = currentGameData.id;
             showModal('report');
        }

        async function handleReportSubmit(event) {
            event.preventDefault();
            if (!currentUser) return;

            const gameId = document.getElementById('report-game-id').value;
            const reason = document.getElementById('report-reason').value.trim();
            const errorElement = document.getElementById('report-error');
            errorElement.classList.add('hidden');

            if (!reason) {
                 errorElement.textContent = 'Please provide a reason.';
                 errorElement.classList.remove('hidden');
                 return;
            }

            try {
                 const { error } = await supabaseClient
                     .from('reports')
                     .insert({
                         game_id: gameId,
                         reason: reason,
                         reporter_user_id: currentUser.id
                     });
                 if (error) throw error;

                 hideModal('report');
                 showMessage("Report submitted successfully. Thank you.");

            } catch (error) {
                 console.error("Error submitting report:", error);
                 errorElement.textContent = `Failed to submit report: ${error.message}`;
                 errorElement.classList.remove('hidden');
            }
        }

        // --- Uploading ---
         async function handleUpload(event) {
            event.preventDefault();
            if (!currentUser) {
                 showMessage("Please log in to upload.", true);
                 return;
            }

            const title = uploadTitle.value.trim();
            const description = uploadDescription.value.trim();
            const category = uploadCategory.value;
            const gameFile = uploadGameFile.files[0];
            const previewFile = uploadPreviewImage.files[0];

             uploadError.classList.add('hidden'); // Clear previous error

            // Basic validation
            if (!title || !description || !category || !gameFile) {
                 uploadError.textContent = 'Please fill in all required fields (Title, Description, Category, Game File).';
                 uploadError.classList.remove('hidden');
                 return;
            }
            if (gameFile.type !== 'text/html') {
                uploadError.textContent = 'Game file must be an .html file.';
                uploadError.classList.remove('hidden');
                return;
            }
             // Optional preview file validation
             if (previewFile && !previewFile.type.startsWith('image/')) {
                 uploadError.textContent = 'Preview file must be an image (JPG, PNG, GIF).';
                 uploadError.classList.remove('hidden');
                 return;
             }

             uploadSubmitButton.disabled = true;
             uploadSubmitButton.textContent = 'Uploading...';
             uploadStatus.textContent = 'Starting upload...';
             uploadStatus.classList.remove('hidden');


             try {
                // 1. Generate unique ID for path (or use Supabase row ID after insert)
                // Using random element + timestamp for pseudo-uniqueness before insert
                const fileSuffix = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                const gameFileName = `game-${fileSuffix}.html`;
                const gameFolderPath = `games/${currentUser.id}/${gameFileName}`; // Path includes user ID

                // 2. Upload Game File
                uploadStatus.textContent = 'Uploading game file...';
                 const { data: gameUploadData, error: gameUploadError } = await supabaseClient.storage
                     .from(GAME_FILES_BUCKET)
                     .upload(gameFolderPath, gameFile);

                 if (gameUploadError) throw new Error(`Game file upload failed: ${gameUploadError.message}`);
                 console.log("Game upload success:", gameUploadData);


                // 3. Upload Preview File (if provided)
                let previewImagePath = null;
                if (previewFile) {
                    uploadStatus.textContent = 'Uploading preview image...';
                     const previewFileExt = previewFile.name.split('.').pop();
                     const previewFileName = `preview-${fileSuffix}.${previewFileExt}`;
                     const previewFolderPath = `previews/${currentUser.id}/${previewFileName}`;

                     const { data: previewUploadData, error: previewUploadError } = await supabaseClient.storage
                         .from(GAME_FILES_BUCKET)
                         .upload(previewFolderPath, previewFile);

                     if (previewUploadError) {
                         // Warn but continue, preview is optional
                         console.warn(`Preview image upload failed: ${previewUploadError.message}`);
                         showMessage("Game uploaded, but preview image failed. You can try editing later (feature not implemented).", true);
                     } else {
                         previewImagePath = previewFolderPath; // Use the relative path
                         console.log("Preview upload success:", previewUploadData);
                     }
                }

                 // 4. Insert Game Metadata into Database
                 uploadStatus.textContent = 'Saving game details...';
                 const { data: gameInsertData, error: gameInsertError } = await supabaseClient
                     .from('games')
                     .insert({
                         title: title,
                         description: description,
                         category: category,
                         uploader_user_id: currentUser.id,
                         game_file_path: gameFolderPath, // Use the relative path
                         preview_image_path: previewImagePath // Use the relative path
                         // likes_count defaults to 0
                     })
                     .select('id') // Select the ID of the newly inserted game
                     .single(); // Expect a single row back

                 if (gameInsertError) throw new Error(`Database insert failed: ${gameInsertError.message}`);
                 console.log("Database insert success:", gameInsertData);

                 // 5. Success
                 uploadStatus.textContent = 'Upload Complete!';
                 showMessage("Game uploaded successfully!");
                 uploadForm.reset(); // Clear the form
                 // Redirect to the new game's page
                 window.location.hash = `#/game/${gameInsertData.id}`;


             } catch (error) {
                 console.error("Upload process error:", error);
                 uploadError.textContent = `Upload failed: ${error.message}`;
                 uploadError.classList.remove('hidden');
                 uploadStatus.classList.add('hidden');
                 // Consider cleanup: delete already uploaded files from storage if DB insert fails? More complex.
             } finally {
                 uploadSubmitButton.disabled = false;
                 uploadSubmitButton.textContent = 'Upload Game';
             }
        }


        // --- Event Listeners ---
        function setupEventListeners() {
            // Navigation Links & Modals
            navLinksContainer.addEventListener('click', (e) => {
                 const target = e.target.closest('a[data-view], button[data-view], a[data-modal], button[data-modal]');
                 if (!target) return;

                 e.preventDefault(); // Prevent default link behavior/button submit

                 if(target.id === 'logout-button') {
                      handleLogout();
                 } else if (target.dataset.view) {
                     // Handled by hashchange event
                     // window.location.hash = target.getAttribute('href');
                 } else if (target.dataset.modal) {
                     showModal(target.dataset.modal);
                 }
            });

             // Modal Close Buttons
             modals.forEach(modal => {
                 modal.addEventListener('click', (e) => {
                     // Close if background or close button is clicked
                     if (e.target.classList.contains('modal') || e.target.classList.contains('modal-close')) {
                          const modalId = modal.id.replace('modal-', '');
                          hideModal(modalId);
                     }
                 });
             });

             // Auth Forms
             loginForm.addEventListener('submit', handleLogin);
             registerForm.addEventListener('submit', handleRegister);

             // Filtering and Sorting
             categoryFilter.addEventListener('change', () => {
                 currentCategory = categoryFilter.value;
                 window.location.hash = `#/category/${encodeURIComponent(currentCategory || 'All')}`; // Trigger route change
             });
             sortBy.addEventListener('change', () => {
                 currentSort = sortBy.value;
                 fetchAndRenderGames(); // Re-fetch with new sort order
             });
             sidebarCategories.addEventListener('click', (e) => {
                  if (e.target.tagName === 'A' && e.target.dataset.category !== undefined) {
                       e.preventDefault();
                       window.location.hash = `#/category/${encodeURIComponent(e.target.dataset.category || 'All')}`;
                  }
             });


            // Game Grid Click (Event Delegation)
            gameGrid.addEventListener('click', (e) => {
                const button = e.target.closest('button.view-game-button');
                if (button && button.dataset.gameId) {
                     e.preventDefault();
                     window.location.hash = `#/game/${button.dataset.gameId}`;
                }
            });

            // Game Play View Buttons
            backButton.addEventListener('click', () => window.location.hash = `#/category/${encodeURIComponent(currentCategory || 'All')}`); // Go back to previous category
            likeButton.addEventListener('click', handleLike);
            downloadButton.addEventListener('click', handleDownload);
            reportButton.addEventListener('click', showReportModal);

             // Report Form Submit
             reportForm.addEventListener('submit', handleReportSubmit);

             // Upload Form Submit
             uploadForm.addEventListener('submit', handleUpload);

             // Terms Link/Button
             document.getElementById('terms-link').addEventListener('click', (e) => { e.preventDefault(); window.location.hash = '#/terms'; });
             document.getElementById('terms-back-button').addEventListener('click', () => { window.history.back(); }); // Simple back navigation

             // Hashchange Listener for Routing
             window.addEventListener('hashchange', handleRouteChange);
        }

        // --- Initialization ---
        function init() {
             console.log("Initializing AI Game Arcade...");
             document.getElementById('copyright-year').textContent = new Date().getFullYear();
             setupEventListeners();
             setupAuthListeners(); // This will also trigger initial route handling
             // Initial game fetch is handled by route handler based on auth state
        }

        // Wait for the DOM to be fully loaded before running scripts
        document.addEventListener('DOMContentLoaded', init);

    </script>

</body>
</html>